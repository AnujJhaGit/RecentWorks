<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TOML to JSON Converter</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
  <style>
    .container {
      max-width: 600px;
      margin-top: 50px;
    }
    .file.has-name .file-name {
      padding: 0.25em 0.5em;
    }
    #copyButton {
      position: absolute;
      top: 10px;
      right: 10px;
    }
  </style>
</head>
<body>
  <div class="container p-3">
    <h1 class="title">TOML to JSON Converter</h1>
    <div class="field">
      <label class="label">Upload TOML file</label>
      <div class="file has-name">
        <label class="file-label">
          <input id="fileInput" class="file-input" type="file" accept=".toml">
          <span class="file-cta">
            <span class="file-icon">
              <i class="fas fa-upload"></i>
            </span>
            <span class="file-label">Choose a fileâ€¦</span>
          </span>
          <span id="fileName" class="file-name"></span>
        </label>
      </div>
    </div>
    <div class="p-4">
      <button id="sampleButton" class="button is-info is-pulled-right">Sample</button>
    </div>
    <div class="field">
      <label class="label">TOML</label>
      <div class="control">
        <textarea id="tomlInput" class="textarea" rows="10" placeholder="Enter TOML here"></textarea>
      </div>
    </div>
    <div class="columns is-centered">
      <div class="column is-narrow">
        <div class="is-flex is-justify-content-flex-start is-align-items-center">
          <button id="convertButton" class="button is-primary">Convert</button>
          <label class="checkbox">
            <input id="auto-checkbox" class="ml-2" type="checkbox" checked>
            Auto
          </label>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">JSON</label>
      <div class="control position-relative">
        <textarea id="jsonOutput" class="textarea" rows="10" readonly></textarea>
        <button id="copyButton" class="button is-info" disabled>Copy JSON</button>
      </div>
    </div>
    <div class="field is-grouped is-justify-content-center">
      <div class="control">
        <button id="downloadButton" class="button is-primary" disabled>Download JSON</button>
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const tomlInput = document.getElementById('tomlInput');
    const jsonOutput = document.getElementById('jsonOutput');
    const convertButton = document.getElementById('convertButton');
    const downloadButton = document.getElementById('downloadButton');
    const sampleButton = document.getElementById('sampleButton');
    const copyButton = document.getElementById('copyButton');
    const auto = document.getElementById('auto-checkbox');

    fileInput.addEventListener('change', handleFileUpload);
    convertButton.addEventListener('click', convertTOMLtoJSON);
    downloadButton.addEventListener('click', downloadJSON);
    sampleButton.addEventListener('click', loadSampleData);
    copyButton.addEventListener('click', copyJSON);

    function handleFileUpload(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const contents = e.target.result;
        tomlInput.value = contents;
        fileName.textContent = file.name;
        if (auto.checked === true) {
          convertButton.click();
        }
      };

      reader.readAsText(file);
    }

    function convertTOMLtoJSON() {
      const tomlData = tomlInput.value.trim();

      try {
        const jsonData = parseTOML(tomlData);
        jsonOutput.value = JSON.stringify(jsonData, null, 2);
        downloadButton.disabled = false;
        copyButton.disabled = false;
      } catch (error) {
        jsonOutput.value = 'Invalid TOML';
        downloadButton.disabled = true;
        copyButton.disabled = true;
      }
    }

    function parseTOML(tomlData) {
      const lines = tomlData.split('\n');
      const jsonData = {};

      let currentObj = jsonData;
      let currentIndent = '';

      for (const line of lines) {
        const trimmedLine = line.trim();
        const indentLength = line.length - trimmedLine.length;

        if (indentLength > currentIndent.length) {
          currentIndent = line.slice(0, indentLength);
        } else if (indentLength < currentIndent.length) {
          currentIndent = currentIndent.slice(0, indentLength);
          currentObj = jsonData;
          const keys = currentIndent.split('  ').map((key) => key.slice(1, -1));
          for (const key of keys) {
            currentObj = currentObj[key];
          }
        }

        if (trimmedLine.length > 0 && !trimmedLine.startsWith('#')) {
          if (trimmedLine.startsWith('[')) {
            const key = trimmedLine.slice(1, -1);
            currentObj[key] = {};
            currentObj = currentObj[key];
          } else {
            const [key, value] = trimmedLine.split(' = ');
            currentObj[key] = parseValue(value);
          }
        }
      }

      return jsonData;
    }

    function parseValue(value) {
      if (value === 'true') return true;
      if (value === 'false') return false;
      if (!isNaN(value)) return parseFloat(value);
      if (value.startsWith('"') && value.endsWith('"')) return value.slice(1, -1);
      if (value.startsWith('[') && value.endsWith(']')) {
        return value.slice(1, -1).split(',').map(parseValue);
      }
      return value;
    }

    function downloadJSON() {
      const jsonData = jsonOutput.value;
      const blob = new Blob([jsonData], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'converted.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function loadSampleData() {
      const sampleTOML = `title = "TOML Example"

[owner]
  name = "John Doe"
  dob = "1985-06-15T08:00:00Z"

[database]
    enabled = true

[ports]
      0 = "8001"
      1 = "8002"
      2 = "8003"

[data]
      0 = "[\\"one\\""
      1 = " 1]"
      2 = " [\\"two\\""
      3 = " 2]"
`;

      tomlInput.value = sampleTOML;
      convertTOMLtoJSON();
    }

    function copyJSON() {
      jsonOutput.select();
      document.execCommand('copy');
      copyButton.textContent = 'Copied!';
      setTimeout(() => {
        copyButton.textContent = 'Copy JSON';
      }, 2000);
    }

    tomlInput.addEventListener('input', function () {
      if (auto.checked === true) {
        convertButton.click();
      }
    });

  </script>

</body>
</html>
